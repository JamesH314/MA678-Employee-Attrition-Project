---
title: "Midterm Project"
author: "Yifeng He"
date: "November 20, 2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,out.width="0.9\\linewidth",dev="png",fig.align  = 'center')
pacman::p_load(
ggplot2,
knitr,
arm,
data.table,
foreign,
gridExtra,
car,
stringr,
rstan,
rstanarm,
zoo,
dplyr,
tidyr,
magrittr,
hrbrthemes,
ggExtra,
stringr,
viridis,
ggridges,
sure
)
```


```{r}
attrition <- read.csv('WA_Fn-UseC_-HR-Employee-Attrition.csv', header = T)
head(attrition)


#convert columns to numeric
cols.num <- c("DistanceFromHome","Age","EnvironmentSatisfaction","MonthlyIncome","TotalWorkingYears","YearsSinceLastPromotion")
attrition[cols.num] <- sapply(attrition[cols.num],as.numeric)
sapply(attrition, class)

attrition$Attrition<-ifelse(attrition$Attrition=="Yes",1,0)

head(attrition)

#variables I choose
col1 <- c("Age","Distance From Home","Environment Satisfaction","Monthly Income","Total Working Years","Years Since Last Promotion")
exp1 <- c("Age of the employee",
          "Distance from company to home",
          "Satisfaction of working environment with 4 levels",
          "Monthly income of employee",
          "Working years since the first career",
          "Working years since last promotion")
df1 <- cbind(col1, exp1)
colnames(df1) <- c("Variables", "Explanation")
knitr::kable(df1, "pipe")
```

|Variables                  |Explanation                                       |
|:--------------------------|:-------------------------------------------------|
|Age                        |Age of the employee                               |
|Distance From Home         |Distance from company to home                     |
|Environment Satisfaction   |Satisfaction of working environment with 4 levels |
|Monthly Income             |Monthly income of employee                        |
|Total Working Years        |Working years since the first career              |
|Years Since Last Promotion |Working years since last promotion                |



```{r}
#bar plots EDA
ggplot(attrition, aes(fill=Attrition, y=DistanceFromHome, x=JobRole)) + 
    geom_bar(position="stack", stat="identity")

ggplot(attrition, aes(fill=Attrition, y=Age, x=JobRole)) + 
    geom_bar(position="stack", stat="identity")

ggplot(attrition, aes(fill=Attrition, y=EnvironmentSatisfaction, x=JobRole)) + 
    geom_bar(position="stack", stat="identity")

ggplot(attrition, aes(fill=Attrition, y=MonthlyIncome, x=JobRole)) + 
    geom_bar(position="stack", stat="identity")

ggplot(attrition, aes(fill=Attrition, y=TotalWorkingYears, x=JobRole)) + 
    geom_bar(position="stack", stat="identity")

ggplot(attrition, aes(fill=Attrition, y=YearsSinceLastPromotion, x=JobRole)) + 
    geom_bar(position="stack", stat="identity")

#scatter plots EDA
ggplot(data=attrition)+
  geom_point(aes(x=Age,y=Attrition,color=JobRole), alpha = 0.3)+
  geom_smooth(aes(x=Age,y=Attrition,color=JobRole), method = "lm", se = FALSE)+
  theme_ipsum()

ggplot(data=attrition)+
  geom_point(aes(x=DistanceFromHome,y=Attrition,color=JobRole), alpha = 0.3)+
  geom_smooth(aes(x=DistanceFromHome,y=Attrition,color=JobRole), method = "lm", se = FALSE)

ggplot(data=attrition)+
  geom_point(aes(x=MonthlyIncome,y=Attrition,color=JobRole), alpha = 0.3)+
  geom_smooth(aes(x=MonthlyIncome,y=Attrition,color=JobRole), method = "lm", se = FALSE)

ggplot(data=attrition)+
  geom_point(aes(x=EnvironmentSatisfaction,y=Attrition,color=JobRole), alpha = 0.3)+
  geom_smooth(aes(x=EnvironmentSatisfaction,y=Attrition,color=JobRole), method = "lm", se = FALSE)

ggplot(data=attrition)+
  geom_point(aes(x=TotalWorkingYears,y=Attrition,color=JobRole), alpha = 0.3)+
  geom_smooth(aes(x=TotalWorkingYears,y=Attrition,color=JobRole), method = "lm", se = FALSE)

ggplot(data=attrition)+
  geom_point(aes(x=YearsSinceLastPromotion,y=Attrition,color=JobRole), alpha = 0.3)+
  geom_smooth(aes(x=YearsSinceLastPromotion,y=Attrition,color=JobRole), method = "lm", se = FALSE)

#marginal distribution EDA
p <- ggplot(attrition, aes(x=MonthlyIncome,y=Attrition,color=JobRole)) +
        geom_point()

ggMarginal(p, type="density")
ggMarginal(p, type="histogram", fill = "slateblue", xparams = list(bins=10), margins = 'x')
ggMarginal(p, margins = 'x', color="purple", size=4)

#other EDAs
ggplot(attrition, aes(x=MonthlyIncome,y=JobRole,color=JobRole)) +
  geom_density_ridges() +
  theme_ridges() + 
  theme(legend.position = "none")

ggplot(attrition, aes(x = `MonthlyIncome`, y = `JobRole`, fill = ..x..)) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01) +
  scale_fill_viridis(name = "Temp. [F]", option = "C") +
  labs(title = 'Temperatures in Lincoln NE in 2016') +
  theme_ipsum() +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    )

ggplot(attrition, aes(x=Age, y=Attrition, size = MonthlyIncome, color = JobRole)) +
    geom_point(alpha=0.7)
```



```{r}
#regression
fit1<-glmer(Attrition~Age+DistanceFromHome+EnvironmentSatisfaction+MonthlyIncome+TotalWorkingYears+YearsSinceLastPromotion+(1|JobRole) ,data = attrition, family = binomial(link = "logit"))
fixef(fit1)
round(fixef(fit1), digits = 5)
ranef(fit1)



fit3<-glmer(Attrition~Age+DistanceFromHome+YearsSinceLastPromotion+TotalWorkingYears+(1+Age|JobRole)+(1+YearsSinceLastPromotion|JobRole)+(1+TotalWorkingYears|JobRole)+(1+DistanceFromHome|JobRole),data = attrition, family = binomial(link = "logit"))
```


```{r}
b1<-binnedplot(fitted(fit1),resid(fit1), nclass=NULL, 
      xlab="Expected Values", ylab="Average residual", 
      main="Binned residual plot", 
      cex.pts=0.8, col.pts=1, col.int="gray")


binnedplot(fitted(fit3),resid(fit3))
```


